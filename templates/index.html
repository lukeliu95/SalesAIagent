<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Video Conference Layout</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const chatWindow = document.querySelector('.chat-window');
        const inputField = document.querySelector('.input-area input');
        const sendButton = document.querySelector('.input-area button');
        const summarizeButton = document.getElementById('summarizeButton');
        const chatSummary = document.querySelector('.chat-summary');
        let typingIndicator = null;

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function renderMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role === 'assistant' ? 'right-align' : 'left-align'}`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${role === 'user' ? '您:' : 'Ryan:'}</strong>
                    <span>${text}</span>
                </div>
            `;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.className = 'chat-message right-align';
                typingIndicator.innerHTML = `
                    <div class="message-content">
                        <strong>Ryan:</strong>
                        <span>正在输入...</span>
                    </div>
                `;
                chatWindow.appendChild(typingIndicator);
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            if (typingIndicator) {
                chatWindow.removeChild(typingIndicator);
                typingIndicator = null;
            }
        }

        function sendMessage() {
            const text = inputField.value.trim();
            if (text) {
                renderMessage('user', text);
                showTypingIndicator();
                socket.emit('send_message', { text: text });
                inputField.value = '';
            }
        }

        sendButton.addEventListener('click', sendMessage);
        inputField.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('sales_response', (data) => {
            hideTypingIndicator();
            renderMessage('assistant', formatResponse(data.text));
        });

        function formatResponse(text) {
            if (Array.isArray(text)) {
                return text.map(item => `<li>${item}</li>`).join('');
            }
            return text;
        }

        summarizeButton.addEventListener('click', () => {
            chatSummary.innerHTML = `
                <div class="loading-summary">
                    <div class="spinner"></div>
                    <p>正在整理会议内容...</p>
                </div>
            `;
            socket.emit('summarize_meeting');
        });

        socket.on('meeting_summary', (data) => {
            if (chatSummary.querySelector('.loading-summary')) {
                chatSummary.innerHTML = '';
            }
            
            const summaryText = data.text;
            chatSummary.innerHTML += summaryText;
            chatSummary.scrollTop = chatSummary.scrollHeight;
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const localVideo = document.getElementById('localVideo');
        const enableButton = document.getElementById('enableButton');
        const disableButton = document.getElementById('disableButton');
        let stream = null;

        async function enableCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: true
                });
                localVideo.srcObject = stream;
                enableButton.style.display = 'none';
                disableButton.style.display = 'block';
                visualizeAudio(stream);
            } catch (err) {
                console.error('获取摄像头失败:', err);
                alert('无法访问摄像头，请确保已授予权限');
            }
        }

        function disableCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
                enableButton.style.display = 'block';
                disableButton.style.display = 'none';
            }
        }

        enableButton.addEventListener('click', enableCamera);
        disableButton.addEventListener('click', disableCamera);
        
        disableButton.style.display = 'none';

        function visualizeAudio(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const canvas = document.getElementById('audioVisualizer');
            const canvasCtx = canvas.getContext('2d');

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                canvasCtx.fillStyle = 'black';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i];
                    canvasCtx.fillStyle = 'rgb(57,255,20)'; // 设置为绿色
                    canvasCtx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
                    x += barWidth + 1;
                }
            }

            draw();
        }
    });
</script>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <div class="menu-section">
                <a href="#" class="menu-item active">
                    <div class="menu-icon">
                        <i class="material-icons">dashboard</i>
                    </div>
                    <span>AI专家团队</span>
                </a>
                <a href="#" class="menu-item">
                    <div class="menu-icon">
                        <i class="material-icons">business</i>
                    </div>
                    <span>企业数据库</span>
                </a>
            </div>
        </div>
        
        <div class="logo-section">
            <h1 class="logo"><img src="static/logo.png" alt="Magellan" width="120"></h1>
            <span class="slogan">智能销售专家</span>
        </div>

        <div class="user-section">
            <div class="user-avatar">
                <img src="static/luke.png" width="35" alt="用户头像">
            </div>
            <span class="user-name">Luke</span>
            <i class="material-icons dropdown-icon">arrow_drop_down</i>

        </div>
    </header>

    <div class="main-content">
        <div class="left-panel">
            <div class="chat-window">
                {% if chat_history %}
                    {% for message in chat_history %}
                        <div class="chat-message {% if message.role == 'assistant' %}right-align{% else %}left-align{% endif %}">
                            <div class="message-content">
                                <strong>{% if message.role == 'user' %}您:{% else %}Ryan:{% endif %}</strong>
                                <span>{{ message.content | safe }}</span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-chat-message">
                        <span>销售提案专家Ryan协助您完成工作</span>
                    </div>
                {% endif %}
            </div>
            <div class="input-area">
                <input type="text" placeholder="输入消息..." autofocus/>
                <button>发送</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="video-section">
                <div class="video-participant">
                    <img src="static/lukeliu.png" alt="数字人图片">
                    <div class="video-label">Ryan销售提案专家</div>
                    <canvas id="salesAudioVisualizer" class="audio-visualizer"></canvas>
                </div>
                <div class="video-participant">
                    <video id="localVideo" autoplay muted></video>
                    <div class="video-label">本地摄像头画面</div>
                    <canvas id="audioVisualizer" class="audio-visualizer"></canvas>
                </div>
            </div>
            <div class="audio-visualizer-container">
                <button id="enableButton">
                    <i class="material-icons">videocam</i>开始视频会议
                </button>
                <button id="disableButton">
                    <i class="material-icons">videocam_off</i>关闭视频会议
                </button>
            </div>
            <div class="chat-summary">
                
            </div>
            <div class="bottom-actions">
                <button id="summarizeButton">整理本轮会议</button>
            </div>
        </div>
    </div>
</body>
</html>