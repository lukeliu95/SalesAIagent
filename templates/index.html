<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Video Conference Layout</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const chatWindow = document.querySelector('.chat-window');
        const inputField = document.querySelector('.input-area input');
        const sendButton = document.querySelector('.input-area button');

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function renderMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role === 'assistant' ? 'right-align' : 'left-align'}`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${role === 'user' ? '您:' : 'Ryan:'}</strong>
                    <span>${text}</span>
                </div>
            `;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        function sendMessage() {
            const text = inputField.value.trim();
            if (text) {
                renderMessage('user', text);
                socket.emit('send_message', { text: text });
                inputField.value = '';
            }
        }

        sendButton.addEventListener('click', sendMessage);
        inputField.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('sales_response', (data) => {
            renderMessage('assistant', data.text);
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const localVideo = document.getElementById('localVideo');
        const enableButton = document.getElementById('enableButton');
        const disableButton = document.getElementById('disableButton');
        let stream = null;

        async function enableCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: true
                });
                localVideo.srcObject = stream;
                enableButton.style.display = 'none';
                disableButton.style.display = 'block';
                visualizeAudio(stream);
            } catch (err) {
                console.error('获取摄像头失败:', err);
                alert('无法访问摄像头，请确保已授予权限');
            }
        }

        function disableCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
                enableButton.style.display = 'block';
                disableButton.style.display = 'none';
            }
        }

        enableButton.addEventListener('click', enableCamera);
        disableButton.addEventListener('click', disableCamera);
        
        disableButton.style.display = 'none';

        function visualizeAudio(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const canvas = document.getElementById('audioVisualizer');
            const canvasCtx = canvas.getContext('2d');

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                canvasCtx.fillStyle = 'black';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i];
                    canvasCtx.fillStyle = 'rgb(57,255,20)'; // 设置为绿色
                    canvasCtx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
                    x += barWidth + 1;
                }
            }

            draw();
        }
    });
</script>
</head>
<body>

<div class="left-panel">
    <div class="chat-window">
        {% for message in chat_history %}
            <div class="chat-message {% if message.role == 'assistant' %}right-align{% else %}left-align{% endif %}">
                <div class="message-content">
                    <strong>{% if message.role == 'user' %}您:{% else %}Ryan:{% endif %}</strong>
                    <span>{{ message.content | safe }}</span>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="input-area">
        <input type="text" placeholder="输入消息..." autofocus/>
        <button>发送</button>
    </div>
</div>

<div class="center-panel">
    <!-- 中间视频窗口，模拟两个参会者视频 -->
    <div class="video-participant">
        <img src="static/lukeliu.png" alt="数字人图片">
        <div class="video-label">Ryan销售提案专家</div>
    </div>
    <div class="video-participant">
        <video id="localVideo" autoplay muted></video>
        <div class="video-label">本地摄像头画面</div>
    </div>
    <canvas id="audioVisualizer" class="audio-visualizer"></canvas>
    <div class="audio-visualizer-container">
        <button id="enableButton">
            <i class="material-icons">videocam</i>开始视频会议
        </button>
        <button id="disableButton">
            <i class="material-icons">videocam_off</i>关闭视频会议
        </button>
    </div>
    
</div>

<div class="right-panel">
    <!-- 右侧聊天内容摘要 -->
    <div class="chat-summary">
        <div class="summary-item">
            <h4>ToDo</h4>
            <p>稍后讨论业务进度</p>
        </div>
        <div class="summary-item">
            <h4>Inspiring Point</h4>
            <p>加快决策，尝试新市场渠道</p>
        </div>
        <div class="summary-item">
            <h4>Key Point</h4>
            <p>节约资源，采用可持续发展策略</p>
        </div>
    </div>
    <div class="bottom-actions">
        <button>共享屏幕</button>
        <button>录制</button>
        <button>设置</button>
    </div>
</div>

</body>
</html>